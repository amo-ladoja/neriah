name: Scheduled Email Sync

# This workflow triggers the /api/webhooks/cron endpoint every 3 hours
# to sync emails for all active users

on:
  # Run every 3 hours
  schedule:
    - cron: '0 */3 * * *'

  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  trigger-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Cron Endpoint
        run: |
          response=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -w "\nHTTP_STATUS:%{http_code}" \
            -s \
            "${{ secrets.VERCEL_APP_URL }}/api/webhooks/cron")

          # Extract HTTP status code
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_STATUS:/d')

          echo "Response Status: $http_status"
          echo "Response Body: $body"

          # Check if request was successful (2xx status code)
          if [[ $http_status -ge 200 && $http_status -lt 300 ]]; then
            echo "✅ Cron sync triggered successfully"
            exit 0
          else
            echo "❌ Cron sync failed with status $http_status"
            exit 1
          fi

      - name: Log Execution Time
        if: always()
        run: |
          echo "Cron execution completed at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
